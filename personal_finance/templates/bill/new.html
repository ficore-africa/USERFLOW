{% extends 'base.html' %}
{% block title %}
{{ trans('bill_add_new_bill', default='Add New Bill') }}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Tool Header -->
    {% set tool_name = 'bill_add_new_bill' %}
    {% set tool_icon = 'fa-plus-circle' %}
    {% set subtitle = trans('bill_add_description', default='Add a new bill to track and manage your payments') %}
    {% include 'tool_header.html' %}

    <!-- Navigation Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('bill.index') }}">{{ trans('bill_bill_planner', default='Bill Planner') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ trans('bill_add_new_bill', default='Add New Bill') }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <!-- Add Bill Form -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>{{ trans('bill_add_new_bill', default='Add New Bill') }}</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('bill.new') }}" id="addBillForm" class="validate-form needs-validation" novalidate>
                        {{ form.csrf_token }}
                        <input type="hidden" name="action" value="add_bill">

                        <!-- Bill Details Section -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.bill_name.id }}" class="form-label">{{ trans('bill_bill_name', default='Bill Name') }}</label>
                                    {{ form.bill_name(class="form-control", placeholder=trans('bill_bill_name_placeholder', default='e.g., NEPA, MTN Data, Ajo Contribution'), required=True, value=form.bill_name.data or '') }}
                                    <div class="invalid-feedback">{{ trans('bill_bill_name_required', default='Bill name is required') }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.amount.id }}" class="form-label">{{ trans('bill_amount', default='Amount') }}</label>
                                    {{ form.amount(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="5000.00", required=True, value=form.amount.data or '') }}
                                    <div class="invalid-feedback">{{ trans('bill_amount_invalid', default='Please enter a valid number between 0 and 10 billion') }}</div>
                                    <small id="amount_help" class="form-text text-muted">{{ trans('bill_amount_help', default='Enter amount (e.g., 5000.00)') }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.due_date.id }}" class="form-label">{{ trans('bill_due_date', default='Due Date') }}</label>
                                    {{ form.due_date(class="form-control", type="date", required=True, value='' if form.due_date.data is none else form.due_date.data.strftime('%Y-%m-%d')) }}
                                    <div class="invalid-feedback">{{ trans('bill_due_date_required', default='Valid due date is required') }}</div>
                                    <small id="due_date_help" class="form-text text-muted">{{ trans('bill_due_date_future_validation', default='Due date must be today or in the future') }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.frequency.id }}" class="form-label">{{ trans('bill_frequency', default='Frequency') }}</label>
                                    {{ form.frequency(class="form-select", required=True) }}
                                    <div class="invalid-feedback">{{ trans('bill_frequency_required', default='Frequency is required') }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.category.id }}" class="form-label">{{ trans('general_category', default='Category') }}</label>
                                    {{ form.category(class="form-select", required=True) }}
                                    <div class="invalid-feedback">{{ trans('bill_category_required', default='Category is required') }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.status.id }}" class="form-label">{{ trans('bill_status', default='Status') }}</label>
                                    {{ form.status(class="form-select", required=True) }}
                                    <div class="invalid-feedback">{{ trans('bill_status_required', default='Status is required') }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Reminder Settings -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6>{{ trans('bill_reminder_settings', default='Reminder Settings') }}</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3 form-check">
                                    {{ form.send_email(class="form-check-input", id="send_email", disabled=not current_user.is_authenticated) }}
                                    <label class="form-check-label" for="send_email">{{ trans('general_send_email', default='Send Email Reminders') }}</label>
                                    {% if not current_user.is_authenticated %}
                                        <small class="form-text text-muted">{{ trans('bill_email_required', default='Email notifications require an authenticated user') }}</small>
                                    {% endif %}
                                    <div class="invalid-feedback">{{ trans('bill_email_required', default='Email notifications require an authenticated user') }}</div>
                                </div>
                                <div class="mb-3" id="reminder_days_container" style="display: {{ 'block' if form.send_email.data else 'none' }};">
                                    <label for="{{ form.reminder_days.id }}" class="form-label">{{ trans('bill_reminder_days', default='Reminder Days') }}</label>
                                    {{ form.reminder_days(class="form-control", type="number", min="1", max="365", step="1", placeholder="7", value=form.reminder_days.data or '') }}
                                    <div class="invalid-feedback">{{ trans('bill_reminder_days_invalid', default='Please enter a valid integer between 1 and 365') }}</div>
                                    <small id="reminder_days_help" class="form-text text-muted">{{ trans('bill_reminder_days_example', default='Example: 7 for a reminder 7 days before due date') }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('bill.index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>{{ trans('general_back', default='Back') }}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{{ trans('bill_save_bill', default='Save Bill') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Tips Sidebar -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>{{ trans('bill_tips', default='Tips') }}</h6>
                </div>
                <div class="card-body">
                    {% if tips %}
                        <ul class="list-unstyled">
                            {% for tip in tips %}
                                <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ trans(tip, default=tip) }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activity -->
            {% if activities %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-clock me-2"></i>{{ trans('general_recent_activity', default='Recent Activity') }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for activity in activities[:5] %}
                                <div class="list-group-item border-0 px-0">
                                    <small class="text-muted">{{ activity.timestamp | format_datetime }}</small>
                                    <div>{{ activity.description }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addBillForm');
    const sendEmailCheckbox = document.getElementById('send_email');
    const reminderDaysContainer = document.getElementById('reminder_days_container');

    // Toggle reminder days visibility
    if (sendEmailCheckbox && reminderDaysContainer) {
        sendEmailCheckbox.addEventListener('change', function() {
            reminderDaysContainer.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Form validation
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                
                // Find first invalid field and focus it
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            form.classList.add('was-validated');
        });
    }
});
</script>
{% endblock %}