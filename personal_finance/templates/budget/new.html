{% extends "base.html" %}
{% block title %}{{ t('budget_create_budget', default='Create Budget') }}{% endblock %}
{% block content %}
<!-- Add CSRF meta tag for AJAX submissions -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mt-4">
    {% set tool_name = 'budget_create_budget' %}
    {% set tool_icon = 'fa-plus-circle' %}
    {% set subtitle = t('budget_create_description', default='Plan your monthly income and expenses to achieve your financial goals') %}
    {% include 'tool_header.html' %}

    <!-- Navigation Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('budget.index') }}">{{ t('budget_title', default='Budget Planner') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ t('budget_create_budget', default='Create Budget') }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <form method="POST" action="{{ url_for('budget.new') }}" id="budgetForm" class="validate-form">
                {{ form.csrf_token }} <!-- CSRF token included -->
                <input type="hidden" name="action" value="create_budget">

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-money-bill-wave me-2"></i>{{ t('budget_monthly_income', default='Monthly Income') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.income.id }}" class="form-label">{{ t('budget_monthly_income', default='Monthly Income') }}</label>
                            {{ form.income(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="500000.00", required=True, value=form.income.data or '') }}
                            {% if form.income.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.income.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small id="income_help" class="form-text text-muted">{{ t('budget_income_help', default='Enter your monthly income (e.g., 500000.00)') }}</small>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h5><i class="fas fa-receipt me-2"></i>{{ t('budget_expenses', default='Monthly Expenses') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.housing.id }}" class="form-label">{{ t('budget_housing_rent', default='Housing/Rent') }}</label>
                                {{ form.housing(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="100000.00", required=True, value=form.housing.data or '') }}
                                {% if form.housing.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.housing.errors %}
                                            {{ t(error, default=error) }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small id="housing_help" class="form-text text-muted">{{ t('budget_housing_help', default='Enter housing cost (e.g., 100000.00)') }}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.food.id }}" class="form-label">{{ t('budget_food', default='Food') }}</label>
                                {{ form.food(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="50000.00", required=True, value=form.food.data or '') }}
                                {% if form.food.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.food.errors %}
                                            {{ t(error, default=error) }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small id="food_help" class="form-text text-muted">{{ t('budget_food_help', default='Enter food cost (e.g., 50000.00)') }}</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.transport.id }}" class="form-label">{{ t('budget_transport', default='Transport') }}</label>
                                {{ form.transport(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="20000.00", required=True, value=form.transport.data or '') }}
                                {% if form.transport.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.transport.errors %}
                                            {{ t(error, default=error) }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small id="transport_help" class="form-text text-muted">{{ t('budget_transport_help', default='Enter transport cost (e.g., 20000.00)') }}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.dependents.id }}" class="form-label">{{ t('budget_dependents_support', default='Dependents Support') }}</label>
                                {{ form.dependents(class="form-control", type="number", min="0", max="100", step="1", placeholder="3", required=True, value=form.dependents.data or '') }}
                                {% if form.dependents.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.dependents.errors %}
                                            {{ t(error, default=error) }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small id="dependents_help" class="form-text text-muted">{{ t('budget_dependents_help', default='Enter number of dependents (e.g., 3)') }}</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.miscellaneous.id }}" class="form-label">{{ t('budget_miscellaneous', default='Miscellaneous') }}</label>
                                {{ form.miscellaneous(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="10000.00", required=True, value=form.miscellaneous.data or '') }}
                                {% if form.miscellaneous.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.miscellaneous.errors %}
                                            {{ t(error, default=error) }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small id="miscellaneous_help" class="form-text text-muted">{{ t('budget_miscellaneous_help', default='Enter miscellaneous cost (e.g., 10000.00)') }}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.others.id }}" class="form-label">{{ t('budget_others', default='Others') }}</label>
                                {{ form.others(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="15000.00", required=True, value=form.others.data or '') }}
                                {% if form.others.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.others.errors %}
                                            {{ t(error, default=error) }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small id="others_help" class="form-text text-muted">{{ t('budget_others_help', default='Enter other expenses (e.g., 15000.00)') }}</small>
                            </div>
                        </div>

                        <!-- Custom Categories Section -->
                        <div class="custom-categories-container mb-3">
                            <h6 class="mt-3">{{ t('budget_custom_categories', default='Custom Categories') }}</h6>
                            <div id="custom-categories">
                                {% for category in form.custom_categories.entries %}
                                    <div class="custom-category-entry row mb-2" data-index="{{ loop.index0 }}">
                                        <div class="col-md-5">
                                            <label for="{{ category.form.name.id }}" class="form-label">{{ t('budget_custom_category_name', default='Category Name') }}</label>
                                            {{ category.form.name(class="form-control", type="text", maxlength="50", placeholder=t('budget_custom_category_placeholder', default='e.g., Vet Bill'), value=category.form.name.data or '') }}
                                            {% if category.form.name.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in category.form.name.errors %}
                                                        {{ t(error, default=error) }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-5">
                                            <label for="{{ category.form.amount.id }}" class="form-label">{{ t('budget_custom_category_amount', default='Amount') }}</label>
                                            {{ category.form.amount(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="10000.00", value=category.form.amount.data or '') }}
                                            {% if category.form.amount.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in category.form.amount.errors %}
                                                        {{ t(error, default=error) }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger btn-sm remove-category"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2 add-custom-category">
                                <i class="fas fa-plus me-2"></i>{{ t('budget_add_custom_category', default='Add Custom Category') }}
                            </button>
                            {% if form.custom_categories.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.custom_categories.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-piggy-bank me-2"></i>{{ t('budget_savings_goal', default='Savings Goal') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.savings_goal.id }}" class="form-label">{{ t('budget_savings_goal', default='Monthly Savings Goal') }}</label>
                            {{ form.savings_goal(class="form-control", type="number", min="0", max="10000000000", step="0.01", placeholder="50000.00", required=True, value=form.savings_goal.data or '') }}
                            {% if form.savings_goal.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.savings_goal.errors %}
                                        {{ t(error, default=error) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small id="savings_goal_help" class="form-text text-muted">{{ t('budget_savings_goal_help', default='Enter your monthly savings goal (e.g., 50000.00)') }}</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('budget.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>{{ t('general_back', default='Back') }}
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-calculator me-2"></i>{{ t('budget_calculate_budget', default='Calculate Budget') }}
                    </button>
                </div>
            </form>
        </div>

        <div class="col-lg-4">
            <!-- Tips Sidebar -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>{{ t('budget_tips', default='Tips') }}</h6>
                </div>
                <div class="card-body">
                    {% if tips %}
                        <ul class="list-unstyled">
                            {% for tip in tips %}
                                <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ t(tip, default=tip) }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ t('budget_tip_track_expenses', default='Track your expenses daily to stay within budget') }}</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ t('budget_tip_ajo_savings', default='Contribute to ajo savings for financial discipline') }}</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ t('budget_tip_data_subscriptions', default='Optimize data subscriptions to reduce costs') }}</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ t('budget_tip_plan_dependents', default='Plan for dependents\' expenses in advance') }}</li>
                        </ul>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activity -->
            {% if activities %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-clock me-2"></i>{{ t('general_recent_activity', default='Recent Activity') }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for activity in activities[:5] %}
                                <div class="list-group-item border-0 px-0">
                                    <small class="text-muted">{{ activity.timestamp | format_datetime }}</small>
                                    <div>{{ activity.description }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('budgetForm');
    const customCategoriesContainer = document.getElementById('custom-categories');
    const addCategoryButton = document.querySelector('.add-custom-category');
    let categoryIndex = {{ form.custom_categories.entries|length }};

    // Template for new custom category
    function createCustomCategoryTemplate(index) {
        return `
            <div class="custom-category-entry row mb-2" data-index="${index}">
                <div class="col-md-5">
                    <label for="custom_categories-${index}-name" class="form-label">{{ t('budget_custom_category_name', default='Category Name') }}</label>
                    <input type="text" class="form-control" name="custom_categories-${index}-name" id="custom_categories-${index}-name" maxlength="50" placeholder="{{ t('budget_custom_category_placeholder', default='e.g., Vet Bill') }}">
                    <div class="invalid-feedback">{{ t('budget_custom_category_name_invalid', default='Please enter a valid category name (max 50 characters)') }}</div>
                </div>
                <div class="col-md-5">
                    <label for="custom_categories-${index}-amount" class="form-label">{{ t('budget_custom_category_amount', default='Amount') }}</label>
                    <input type="number" class="form-control" name="custom_categories-${index}-amount" id="custom_categories-${index}-amount" min="0" max="10000000000" step="0.01" placeholder="10000.00">
                    <div class="invalid-feedback">{{ t('budget_custom_category_amount_invalid', default='Please enter a valid number between 0 and 10 billion') }}</div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-category"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    }

    // Add new custom category
    addCategoryButton.addEventListener('click', function() {
        if (categoryIndex < 10) { // Limit to 10 categories as specified
            customCategoriesContainer.insertAdjacentHTML('beforeend', createCustomCategoryTemplate(categoryIndex));
            categoryIndex++;
            attachRemoveEventListeners();
            updateValidation();
        } else {
            alert('{{ t('budget_max_custom_categories', default='Maximum of 10 custom categories allowed') }}');
        }
    });

    // Attach remove event listeners to all remove buttons
    function attachRemoveEventListeners() {
        const removeButtons = document.querySelectorAll('.remove-category');
        removeButtons.forEach(button => {
            button.removeEventListener('click', removeCategoryHandler); // Prevent duplicate listeners
            button.addEventListener('click', removeCategoryHandler);
        });
    }

    function removeCategoryHandler() {
        const entry = this.closest('.custom-category-entry');
        entry.remove();
    }

    // Real-time validation for all inputs
    function updateValidation() {
        const inputs = form.querySelectorAll('input[type="number"], input[type="text"]');
        inputs.forEach(input => {
            input.removeEventListener('input', validateInputHandler); // Prevent duplicate listeners
            input.addEventListener('input', validateInputHandler);
        });
    }

    function validateInputHandler() {
        if (this.checkValidity()) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    }

    // Form submission with AJAX support
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission for AJAX
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            const formData = new FormData(form);
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            fetch('{{ url_for("budget.new") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest' 
                },
                body: formData
            })
            .then(response => response.json().then(data => ({ status: response.status, data })))
            .then(({ status, data }) => {
                if (status === 200 && data.success) {
                    window.location.href = '{{ url_for("budget.dashboard") }}';
                } else {
                    alert(data.message || '{{ t("budget_form_invalid", default="Invalid form data. Please check your inputs.") }}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{{ t("budget_submission_error", default="Error submitting budget. Please try again.") }}');
            });
        });

        // Initial validation setup
        updateValidation();
        attachRemoveEventListeners();
    }
});
</script>
{% endblock %}

